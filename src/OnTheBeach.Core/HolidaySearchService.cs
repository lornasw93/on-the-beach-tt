using OnTheBeach.Domain;
using OnTheBeach.Domain.Requests;
using OnTheBeach.Domain.Responses;
using System.Text.Json;

namespace OnTheBeach.Core;

public class HolidaySearchService : IHolidaySearchService
{
    public IEnumerable<Holiday> Search(HolidaySearchRequest request)
    {
        var jsonData = "{\r\n  \"flights\": [\r\n    {\r\n      \"id\": 1,\r\n      \"airline\": \"First Class Air\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"TFS\",\r\n      \"price\": 470,\r\n      \"departure_date\": \"2023-07-01\"\r\n    },\r\n    {\r\n      \"id\": 2,\r\n      \"airline\": \"Oceanic Airlines\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"AGP\",\r\n      \"price\": 245,\r\n      \"departure_date\": \"2023-07-01\"\r\n    },\r\n    {\r\n      \"id\": 3,\r\n      \"airline\": \"Trans American Airlines\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"PMI\",\r\n      \"price\": 170,\r\n      \"departure_date\": \"2023-06-15\"\r\n    },\r\n    {\r\n      \"id\": 4,\r\n      \"airline\": \"Trans American Airlines\",\r\n      \"from\": \"LTN\",\r\n      \"to\": \"PMI\",\r\n      \"price\": 153,\r\n      \"departure_date\": \"2023-06-15\"\r\n    },\r\n    {\r\n      \"id\": 5,\r\n      \"airline\": \"Fresh Airways\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"PMI\",\r\n      \"price\": 130,\r\n      \"departure_date\": \"2023-06-15\"\r\n    },\r\n    {\r\n      \"id\": 6,\r\n      \"airline\": \"Fresh Airways\",\r\n      \"from\": \"LGW\",\r\n      \"to\": \"PMI\",\r\n      \"price\": 75,\r\n      \"departure_date\": \"2023-06-15\"\r\n    },\r\n    {\r\n      \"id\": 7,\r\n      \"airline\": \"Trans American Airlines\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"LPA\",\r\n      \"price\": 125,\r\n      \"departure_date\": \"2022-11-10\"\r\n    },\r\n    {\r\n      \"id\": 8,\r\n      \"airline\": \"Fresh Airways\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"LPA\",\r\n      \"price\": 175,\r\n      \"departure_date\": \"2023-11-10\"\r\n    },\r\n    {\r\n      \"id\": 9,\r\n      \"airline\": \"Fresh Airways\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"AGP\",\r\n      \"price\": 140,\r\n      \"departure_date\": \"2023-04-11\"\r\n    },\r\n    {\r\n      \"id\": 10,\r\n      \"airline\": \"First Class Air\",\r\n      \"from\": \"LGW\",\r\n      \"to\": \"AGP\",\r\n      \"price\": 225,\r\n      \"departure_date\": \"2023-07-01\"\r\n    },\r\n    {\r\n      \"id\": 11,\r\n      \"airline\": \"First Class Air\",\r\n      \"from\": \"LGW\",\r\n      \"to\": \"AGP\",\r\n      \"price\": 155,\r\n      \"departure_date\": \"2023-07-01\"\r\n    },\r\n    {\r\n      \"id\": 12,\r\n      \"airline\": \"Trans American Airlines\",\r\n      \"from\": \"MAN\",\r\n      \"to\": \"AGP\",\r\n      \"price\": 202,\r\n      \"departure_date\": \"2023-10-25\"\r\n    }\r\n  ],\r\n  \"hotels\": [\r\n    {\r\n      \"id\": 1,\r\n      \"name\": \"Iberostar Grand Portals Nous\",\r\n      \"arrival_date\": \"2022-11-05\",\r\n      \"price_per_night\": 100,\r\n      \"local_airports\": [ \"TFS\" ],\r\n      \"nights\": 7\r\n    },\r\n    {\r\n      \"id\": 2,\r\n      \"name\": \"Laguna Park 2\",\r\n      \"arrival_date\": \"2022-11-05\",\r\n      \"price_per_night\": 50,\r\n      \"local_airports\": [ \"TFS\" ],\r\n      \"nights\": 7\r\n    },\r\n    {\r\n      \"id\": 3,\r\n      \"name\": \"Sol Katmandu Park & Resort\",\r\n      \"arrival_date\": \"2023-06-15\",\r\n      \"price_per_night\": 59,\r\n      \"local_airports\": [ \"PMI\" ],\r\n      \"nights\": 14\r\n    },\r\n    {\r\n      \"id\": 4,\r\n      \"name\": \"Sol Katmandu Park & Resort\",\r\n      \"arrival_date\": \"2023-06-15\",\r\n      \"price_per_night\": 59,\r\n      \"local_airports\": [ \"PMI\" ],\r\n      \"nights\": 14\r\n    },\r\n    {\r\n      \"id\": 5,\r\n      \"name\": \"Sol Katmandu Park & Resort\",\r\n      \"arrival_date\": \"2023-06-15\",\r\n      \"price_per_night\": 60,\r\n      \"local_airports\": [ \"PMI\" ],\r\n      \"nights\": 10\r\n    },\r\n    {\r\n      \"id\": 6,\r\n      \"name\": \"Club Maspalomas Suites and Spa\",\r\n      \"arrival_date\": \"2022-11-10\",\r\n      \"price_per_night\": 75,\r\n      \"local_airports\": [ \"LPA\" ],\r\n      \"nights\": 14\r\n    },\r\n    {\r\n      \"id\": 7,\r\n      \"name\": \"Club Maspalomas Suites and Spa\",\r\n      \"arrival_date\": \"2022-09-10\",\r\n      \"price_per_night\": 76,\r\n      \"local_airports\": [ \"LPA\" ],\r\n      \"nights\": 14\r\n    },\r\n    {\r\n      \"id\": 8,\r\n      \"name\": \"Boutique Hotel Cordial La Peregrina\",\r\n      \"arrival_date\": \"2022-10-10\",\r\n      \"price_per_night\": 45,\r\n      \"local_airports\": [ \"LPA\" ],\r\n      \"nights\": 7\r\n    },\r\n    {\r\n      \"id\": 9,\r\n      \"name\": \"Nh Malaga\",\r\n      \"arrival_date\": \"2023-07-01\",\r\n      \"price_per_night\": 83,\r\n      \"local_airports\": [ \"AGP\" ],\r\n      \"nights\": 7\r\n    },\r\n    {\r\n      \"id\": 10,\r\n      \"name\": \"Barcelo Malaga\",\r\n      \"arrival_date\": \"2023-07-05\",\r\n      \"price_per_night\": 45,\r\n      \"local_airports\": [ \"AGP\" ],\r\n      \"nights\": 10\r\n    },\r\n    {\r\n      \"id\": 11,\r\n      \"name\": \"Parador De Malaga Gibralfaro\",\r\n      \"arrival_date\": \"2023-10-16\",\r\n      \"price_per_night\": 100,\r\n      \"local_airports\": [ \"AGP\" ],\r\n      \"nights\": 7\r\n    },\r\n    {\r\n      \"id\": 12,\r\n      \"name\": \"MS Maestranza Hotel\",\r\n      \"arrival_date\": \"2023-07-01\",\r\n      \"price_per_night\": 45,\r\n      \"local_airports\": [ \"AGP\" ],\r\n      \"nights\": 14\r\n    },\r\n    {\r\n      \"id\": 13,\r\n      \"name\": \"Jumeirah Port Soller\",\r\n      \"arrival_date\": \"2023-06-15\",\r\n      \"price_per_night\": 295,\r\n      \"local_airports\": [ \"PMI\" ],\r\n      \"nights\": 10\r\n    }\r\n  ]\r\n}";
        var holidays = JsonSerializer.Deserialize<HolidaySearchResponse>(jsonData, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

        if (holidays == null || holidays.Flights == null || holidays.Hotels == null)
        {
            return [];
        }

        var results = holidays.Flights.SelectMany(flight => holidays.Hotels,
                                            (flight, hotel) => new { Flight = flight, Hotel = hotel })
                                      .Where(x => (x.Hotel.LocalAirports.Contains(x.Flight.From) || x.Hotel.LocalAirports.Contains(x.Flight.To))
                                                    || (!request.Duration.HasValue || x.Hotel.Nights == request.Duration.Value))
                                      .Select(x => new Holiday
                                      {
                                          Flight = x.Flight,
                                          Hotel = x.Hotel
                                      });

        return results ?? [];
    }
}
